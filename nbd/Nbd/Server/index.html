<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Server (nbd.Nbd.Server)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../../index.html">nbd</a></span></nav><header><h1><span class="keyword">Module</span> <span class="module-path">Nbd.Server</span></h1></header><p>A Server which allows you to expose an existing block device to
remote clients over NBD.</p><div class="spec include"><div class="doc"></div><details open="open"><summary><span class="def"><code><span class="keyword">include </span><a href="../S/index.html#module-type-SERVER">S.SERVER</a></code></span></summary><p>A Server allows you to expose an existing block device to remote clients
over NBD.</p><div class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>t</code><code></code><code></code></div><div class="doc"><p>An open connection to an NBD client</p></div></div><div class="spec type" id="type-size"><a href="#type-size" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>size</code><code><span class="keyword"> = </span>int64</code><code></code></div><div class="doc"><p>The size of a remote disk</p></div></div><div class="spec type" id="type-name"><a href="#type-name" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>name</code><code><span class="keyword"> = </span>string</code><code></code></div><div class="doc"><p>The name of an export. In the 'new style' protocol as used in nbd &gt;= 2.9.17
the client must select an export by name.</p></div></div><div class="spec exception" id="exception-Client_requested_abort"><a href="#exception-Client_requested_abort" class="anchor"></a><div class="def exception"><code><span class="keyword">exception </span></code><code><span class="exception">Client_requested_abort</span></code></div><div class="doc"><p>The client terminated the option haggling phase by sending NBD_OPT_ABORT</p></div></div><div class="spec val" id="val-connect"><a href="#val-connect" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>connect : <a href="../Channel/index.html#type-cleartext_channel">Channel.cleartext_channel</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;offer:<a href="index.html#type-name">name</a> list <span class="keyword">&#8209;&gt;</span> unit <span class="keyword">&#8209;&gt;</span> (<a href="index.html#type-name">name</a><span class="keyword"> * </span><a href="index.html#type-t">t</a>) Lwt.t</code></div><div class="doc"><p><code class="code">connect cleartext_channel ?offer ()</code> performs the 'new style' initial
handshake and options negotiation.
Note that FORCEDTLS mode will be used in the negotiation unless
<code class="code">cleartext_channel.make_tls_channel</code> is None, signifying NOTLS mode.
If <code class="code">?offer</code> is provided then these names will be returned if the client
requests a list of exports, otherwise we will return EPERM.
The client's choice of name is returned which must be looked up by the
application. If the name is invalid, the only option is to close the connection.
If the name is valid then use the <code class="code">serve</code> function.</p><p>Raises <a href="index.html#exception-Client_requested_abort">Client_requested_abort</a> if the client aborts the option haggilng
phase instead of entering the transmission phase</p></div></div><div class="spec val" id="val-serve"><a href="#val-serve" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>serve : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;read_only:bool <span class="keyword">&#8209;&gt;</span> (<span class="keyword">module </span>Mirage_block_lwt.S <span class="keyword">with</span> <span class="keyword">type </span>t <span class="keyword">=</span> <span class="type-var">'b</span>) <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span> <span class="keyword">&#8209;&gt;</span> unit Lwt.t</code></div><div class="doc"><p><code class="code">serve t read_only block b</code> runs forever processing requests from <code class="code">t</code>, using <code class="code">block</code>
device type <code class="code">b</code>. If <code class="code">read_only</code> is true, which is the default, the
<code class="code">block</code> device <code class="code">b</code> is served in read-only mode: the server will set the
NBD_FLAG_READ_ONLY transmission flag, and if the client issues a write
command, the server will send an EPERM error to the client and will
terminate the session.</p></div></div><div class="spec val" id="val-close"><a href="#val-close" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>close : <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> unit Lwt.t</code></div><div class="doc"><p><code class="code">close t</code> shuts down the connection <code class="code">t</code> and frees any allocated resources</p></div></div><div class="spec val" id="val-with_connection"><a href="#val-with_connection" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>with_connection : <a href="../Channel/index.html#type-cleartext_channel">Channel.cleartext_channel</a> <span class="keyword">&#8209;&gt;</span> ?&#8288;offer:<a href="index.html#type-name">name</a> list <span class="keyword">&#8209;&gt;</span> (string <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> unit Lwt.t) <span class="keyword">&#8209;&gt;</span> unit Lwt.t</code></div><div class="doc"><p><code class="code">with_connection clearchan ~offer f</code> calls <code class="code">connect clearchan ~offer</code> and
attempts to apply <code class="code">f</code> to the resulting <code class="code">t</code>, with a guarantee to call
<code class="code">close t</code> afterwards.</p></div></div></details></div></body></html>